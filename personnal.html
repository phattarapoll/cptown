<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ผังบุคลากร เทศบาลเมืองชุมพร | Organization Chart</title>
    
    <link rel="stylesheet" href="assets/css/personal.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
</head>
<body>

    <button class="back-button animate__animated animate__fadeInLeft" onclick="window.history.back()">
        <span class="button-text">← ย้อนกลับ</span>
    </button>
    
    <header class="main-header animate__animated animate__fadeInDown">
        <h1 class="main-heading">ผังบุคลากร</h1>
        <p class="sub-heading">เทศบาลเมืองชุมพร</p>
    </header>

    <main class="content-container animate__animated animate__fadeInUp">
        <div id="orgChartContainer"></div>
    </main>
    
    <footer class="main-footer animate__animated animate__fadeIn">
        <p class="footer-text">© 2025 เทศบาลเมืองชุมพร</p>
    </footer>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyIcB4foHKA6XZ1Eg9zGCXYo_kx7iMOkl_7GC5wshB4PhMb_-XQpS_E9OUF-r9pDYaz/exec';
        const container = document.getElementById('orgChartContainer');

        async function fetchAndRenderOrgChart() {
            try {
                const response = await fetch(scriptURL + '?action=getOrgChart&origin=' + encodeURIComponent(window.location.origin));
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const result = await response.json();
                
                if (result.status === 'success') {
                    const groupedData = result.data;
                    const sortedLevels = Object.keys(groupedData).sort((a, b) => b - a);

                    let html = '';
                    sortedLevels.forEach(level => {
                        html += `
                            <div class="level-container">
                                <h2>${groupedData[level][0]['ตำแหน่ง']}</h2>
                                <div class="employee-group">
                        `;
                        groupedData[level].forEach(employee => {
                            html += `
                                <div class="employee-card">
                                    <img src="${employee['รูปภาพ']}" alt="${employee['ชื่อ-สกุล']}">
                                    <h3>${employee['ชื่อ-สกุล']}</h3>
                                    <p>${employee['ตำแหน่ง']}</p>
                                </div>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    throw new Error(result.message || 'Failed to fetch data from API');
                }
            } catch (error) {
                console.error('Error fetching org chart:', error);
                container.innerHTML = '<p class="error-message">ไม่สามารถโหลดข้อมูลผังบุคลากรได้ในขณะนี้ กรุณาลองใหม่อีกครั้ง</p>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', fetchAndRenderOrgChart);
    </script>
</body>
</html>