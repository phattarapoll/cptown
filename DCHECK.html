<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>งานทันตสาธารณสุข - ล็อกอิน</title>
  <link rel="stylesheet" href="assets/css/styleDcheck.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* ---------------------------------------------------------------------------------- */
    /* ส่วนของ Style สำหรับหน้าจอ Login ที่เพิ่มเข้ามา */
    /* ---------------------------------------------------------------------------------- */
    #login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f4f7f6; /* สีพื้นหลังอ่อน ๆ */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000; /* ให้ทับหน้าจออื่น ๆ ทั้งหมด */
      font-family: 'Sarabun', sans-serif;
      flex-direction: column;
    }

    #login-box {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 90%;
      max-width: 350px;
    }

    #passcode-display {
      height: 40px;
      margin-bottom: 20px;
      border: 2px solid #ccc;
      border-radius: 8px;
      font-size: 24px;
      line-height: 36px;
      color: #333;
      text-align: center;
      letter-spacing: 5px; /* Spacing between digits for better look */
      background-color: #e9ecef;
    }

    #keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .keypad-button {
      background-color: #007bff; /* สีน้ำเงินหลัก */
      color: white;
      border: none;
      border-radius: 8px;
      padding: 20px 10px;
      font-size: 24px;
      cursor: pointer;
      transition: background-color 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .keypad-button:hover {
      background-color: #0056b3;
    }

    .keypad-button:active {
      background-color: #004085;
      box-shadow: none;
      transform: translateY(1px);
    }

    .keypad-button.action {
      background-color: #6c757d; /* สีเทาสำหรับปุ่ม Clear/Backspace */
      font-size: 18px;
    }
    /* กำหนดขนาดไอคอน Backspace */
    .keypad-button.action i {
        font-size: 24px;
    }

    .keypad-button.action:hover {
      background-color: #5a6268;
    }

    #enter-button {
      grid-column: span 3;
      background-color: #28a745; /* สีเขียวสำหรับปุ่มตกลง */
      font-size: 20px;
      padding: 15px 10px;
      margin-top: 10px;
    }

    #enter-button:hover {
      background-color: #218838;
    }

    #message {
        color: red;
        font-weight: bold;
        min-height: 20px; /* กันการกระโดดขององค์ประกอบอื่น */
    }

    /* Updated styles for the submission history display (from original file) */
    #submission-history {
      position: fixed;
      top: 20px;
      right: 20px;
      color: #333; /* Dark gray text color */
      padding: 10px 15px;
      font-weight: bold;
      z-index: 1000;
      display: none; /* Hidden by default, will be shown if history exists */
      line-height: 1.6; /* Spacing between lines */
      text-align: right; /* Align text to the right */
    }
    #submission-history p {
      margin: 0; /* Remove default paragraph margins */
      padding: 3px 0;
      border-bottom: 1px dotted #ccc; /* Subtle separator */
    }
    #submission-history p:last-child {
      border-bottom: none; /* No border for the last item */
    }
    #submission-history p strong {
      color: #0056b3; /* A bit more prominent color for the code */
    }

    /* เมื่อล็อกอินสำเร็จ ให้ซ่อน overlay */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="login-overlay">
    <div id="login-box">
        <h2>กรุณาป้อนรหัสผ่าน</h2>
        <div id="passcode-display"></div>
        <p id="message"></p>
        <div id="keypad">
            <button type="button" class="keypad-button" data-key="1">1</button>
            <button type="button" class="keypad-button" data-key="2">2</button>
            <button type="button" class="keypad-button" data-key="3">3</button>
            <button type="button" class="keypad-button" data-key="4">4</button>
            <button type="button" class="keypad-button" data-key="5">5</button>
            <button type="button" class="keypad-button" data-key="6">6</button>
            <button type="button" class="keypad-button" data-key="7">7</button>
            <button type="button" class="keypad-button" data-key="8">8</button>
            <button type="button" class="keypad-button" data-key="9">9</button> <button type="button" class="keypad-button action" id="clear-button">ล้าง</button> <button type="button" class="keypad-button" data-key="0">0</button>
            <button type="button" class="keypad-button action" id="backspace-button"><i class="fas fa-backspace"></i></button> <button type="button" class="keypad-button action" id="enter-button">ตกลง</button>
        </div>
    </div>
  </div>

  <div id="submission-history"></div> 
  <div class="container" id="main-content">
    <h1> PROGRAM DENTCHECK V.5 </h1>
    
    <form id="dataForm">
      <div class="main-content-grid">
        <div class="left-column">
          <div class="section gray1">
            <label>วันที่
              <input type="date" id="date" name="date"> </label>
            <label>รหัส
              <input type="number" id="code" name="id"> </label>
            <label>ชั้น
              <input type="text" id="class" name="grade" list="gradeOptions"> <datalist id="gradeOptions">
                <option value="ป.1">
                <option value="ป.2">
                <option value="ป.3">
                <option value="ป.4">
                <option value="ป.5">
                <option value="ป.6">
                <option value="ม.1">
              </datalist>
            </label>
            <label>โรงเรียน
              <select id="school" name="school">
                <option value="สหศึกษา">สหศึกษา</option>
                <option value="ฝวาหมินกงลิ">ฝวาหมินกงลิ</option>
                <option value="เทศบาล1ท่าตะเภา">เทศบาล1ท่าตะเภา</option>
                <option value="อนุบาลเมืองชุมพร">อนุบาลเมืองชุมพร</option>			
                <option value="สอาดเผดิมวิทยา">สอาดเผดิมวิทยา</option>
                <option value="ศรียาภัย">ศรียาภัย</option>
              </select>
            </label>
          </div>

          <div class="section gray05">
            <label>จำนวนฟันแท้ <input type="number" min="0" max="32" id="np" name="NP"></label>
            <label>จำนวนฟันแท้ผุ <input type="number" min="0" max="32" id="cp" name="CP" readonly></label>
            <label>จำนวนฟันน้ำนม <input type="number" min="0" max="20" id="nm" name="NM"></label>
            <label>ฟันน้ำนมต้องอุด <input type="number" min="0" max="20" id="cm" name="CM"></label>
          </div>
        </div> <div class="right-column">
          <div class="section gray05 center-buttons">
            <button type="button" class="action-button special" id="scButton" data-name="sc"><span>แนะนำขูดหินปูน</span></button>
            <button type="button" class="action-button special" id="exButton" data-name="ex"><span>แนะนำถอน</span></button>
          </div>

          <div class="section gray076">
            <h2>เคลือบหลุมร่องฟัน (Sealants)</h2>
            <div class="button-group" id="slButtonGroup">
              <button type="button" class="action-button" data-name="sl27"><span>27</span></button>
              <button type="button" class="action-button" data-name="sl26"><span>26</span></button>
              <button type="button" class="action-button" data-name="sl17"><span>17</span></button>
              <button type="button" class="action-button" data-name="sl16"><span>16</span></button>
            </div>
            <div class="button-group">	  
              <button type="button" class="action-button" data-name="sl37"><span>37</span></button>
              <button type="button" class="action-button" data-name="sl36"><span>36</span></button>
              <button type="button" class="action-button" data-name="sl46"><span>46</span></button>
              <button type="button" class="action-button" data-name="sl47"><span>47</span></button>
            </div>
          </div>

          <div class="section gray05">
            <h2>ให้การรักษา (Treatment)</h2>
            <div class="tooth-treatment-grid">
              <button type="button" class="action-button" data-name="t27"><span>27</span></button> <button type="button" class="action-button" data-name="t26"><span>26</span></button> <button type="button" class="action-button" data-name="t25"><span>25</span></button> <button type="button" class="action-button" data-name="t24"><span>24</span></button> <button type="button" class="action-button" data-name="t23"><span>23</span></button> <button type="button" class="action-button" data-name="t22"><span>22</span></button> <button type="button" class="action-button" data-name="t21"><span>21</span></button> <button type="button" class="action-button" data-name="t11"><span>11</span></button> <button type="button" class="action-button" data-name="t12"><span>12</span></button> <button type="button" class="action-button" data-name="t13"><span>13</span></button> <button type="button" class="action-button" data-name="t14"><span>14</span></button> <button type="button" class="action-button" data-name="t15"><span>15</span></button> <button type="button" class="action-button" data-name="t16"><span>16</span></button> <button type="button" class="action-button" data-name="t17"><span>17</span></button>
              <div class="grid-row-break"></div> <button type="button" class="action-button" data-name="t37"><span>37</span></button> <button type="button" class="action-button" data-name="t36"><span>36</span></button> <button type="button" class="action-button" data-name="t35"><span>35</span></button> <button type="button" class="action-button" data-name="t34"><span>34</span></button> <button type="button" class="action-button" data-name="t33"><span>33</span></button> <button type="button" class="action-button" data-name="t32"><span>32</span></button> <button type="button" class="action-button" data-name="t31"><span>31</span></button> <button type="button" class="action-button" data-name="t41"><span>41</span></button> <button type="button" class="action-button" data-name="t42"><span>42</span></button> <button type="button" class="action-button" data-name="t43"><span>43</span></button> <button type="button" class="action-button" data-name="t44"><span>44</span></button> <button type="button" class="action-button" data-name="t45"><span>45</span></button> <button type="button" class="action-button" data-name="t46"><span>46</span></button> <button type="button" class="action-button" data-name="t47"><span>47</span></button>
            </div>
          </div>
          <div class="submit-button-container">
            <button type="submit" class="submit-btn">ส่งข้อมูล</button>
          </div>
        </div> </div> </form>
	<br><br><br><br><br><br>
	<h6>ผู้สร้างและพัฒนา...นายภัทรพล ไพศาลวัชรเมธี ทันตสาธารณสุขอาวุโส </h6>
  </div>

  <script>
    // ----------------------------------------------------------------------------------
    // ส่วนของ Login Script
    // ----------------------------------------------------------------------------------
    const CORRECT_PASSCODE = "122333";
    const passcodeDisplay = document.getElementById("passcode-display");
    const loginOverlay = document.getElementById("login-overlay");
    const keypadButtons = document.querySelectorAll(".keypad-button[data-key]");
    const enterButton = document.getElementById("enter-button");
    const clearButton = document.getElementById("clear-button");
    const backspaceButton = document.getElementById("backspace-button"); // เพิ่มตัวแปรสำหรับปุ่ม Backspace
    const messageElement = document.getElementById("message");
    let currentPasscode = "";

    // ฟังก์ชันอัปเดตการแสดงผลรหัสผ่าน
    function updatePasscodeDisplay() {
        // แทนที่ตัวเลขด้วยเครื่องหมายดอกจัน (*)
        passcodeDisplay.textContent = "*".repeat(currentPasscode.length);
        messageElement.textContent = ""; // ล้างข้อความแจ้งเตือน
    }

    // เพิ่ม Event Listener ให้กับปุ่มตัวเลข (1-9, 0)
    keypadButtons.forEach(button => {
        button.addEventListener("click", function() {
            const key = this.dataset.key;
            currentPasscode += key;
            updatePasscodeDisplay();
        });
    });

    // Event Listener สำหรับปุ่ม "ล้าง" (Clear All)
    clearButton.addEventListener("click", function() {
        currentPasscode = "";
        updatePasscodeDisplay();
    });

    // Event Listener สำหรับปุ่ม "ลบทีละตัว" (Backspace)
    backspaceButton.addEventListener("click", function() {
        // ลบตัวอักษรตัวสุดท้ายออก
        currentPasscode = currentPasscode.slice(0, -1);
        updatePasscodeDisplay();
    });

    // Event Listener สำหรับปุ่ม "ตกลง"
    enterButton.addEventListener("click", function() {
        if (currentPasscode === CORRECT_PASSCODE) {
            // ล็อกอินสำเร็จ
            loginOverlay.classList.add("hidden");
            // เรียกฟังก์ชันตั้งค่าเริ่มต้นของหน้าหลัก (ซึ่งอยู่ในส่วนด้านล่าง)
            initialSetup(); 
        } else {
            // ล็อกอินไม่สำเร็จ
            messageElement.textContent = "รหัสผ่านไม่ถูกต้อง กรุณาลองใหม่อีกครั้ง";
            currentPasscode = ""; // ล้างรหัสผ่านที่ป้อน
            passcodeDisplay.textContent = ""; // แสดงผลเป็นค่าว่าง
        }
    });

    // ----------------------------------------------------------------------------------
    // ส่วนของ Script เดิม
    // ----------------------------------------------------------------------------------
    const scriptURL = "https://script.google.com/macros/s/AKfycbwgNSARmEVj9bZU9euDyAkkuOb8PeJOtsHKHVjFcUR0AhP1ZQcOKcs4f4JmKk3H_fv-xg/exec";
    const form = document.getElementById("dataForm");
    const classInput = document.getElementById("class");
    const npInput = document.getElementById("np");
    const nmInput = document.getElementById("nm");
    const cpInput = document.getElementById("cp");
    const submitButton = document.querySelector('.submit-button-container .submit-btn');
    const codeInput = document.getElementById("code");
    const submissionHistoryContainer = document.getElementById('submission-history'); // Changed ID
    const dateInput = document.getElementById("date"); // เพิ่มตัวแปรสำหรับช่องวันที่

    // เพิ่ม "date" ในรายการฟิลด์ที่ต้องการจำค่า
    const fieldsToRemember = ["date", "grade", "school", "NP", "NM", "CM"];

    let submissionHistory = []; // Array to hold history objects {code: '...', time: '...'}
    const MAX_HISTORY_ITEMS = 2;
    const HISTORY_STORAGE_KEY = 'dentalSubmissionHistory'; // Key for localStorage

    // Function to load history from localStorage
    function loadSubmissionHistory() {
      const saved = localStorage.getItem(HISTORY_STORAGE_KEY);
      if (saved) {
        try {
          submissionHistory = JSON.parse(saved);
          // Ensure it's an array and trim if somehow it got too big
          if (!Array.isArray(submissionHistory)) {
            submissionHistory = [];
          } else if (submissionHistory.length > MAX_HISTORY_ITEMS) {
            submissionHistory = submissionHistory.slice(-MAX_HISTORY_ITEMS); // Take last MAX_HISTORY_ITEMS
          }
        } catch (e) {
          console.error("Error parsing submission history from localStorage:", e);
          submissionHistory = []; // Reset on error
        }
      }
    }

    // Function to save history to localStorage
    function saveSubmissionHistory() {
      localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(submissionHistory));
    }

    // Function to update the display of history on the page
    function updateSubmissionHistoryDisplay() {
      submissionHistoryContainer.innerHTML = ''; // Clear current display
      if (submissionHistory.length === 0) {
        submissionHistoryContainer.style.display = 'none'; // Hide if no history
        return;
      }
      submissionHistoryContainer.style.display = 'block'; // Show if there is history

      // Iterate from most recent to oldest for display order (newest at top)
      for (let i = submissionHistory.length - 1; i >= 0; i--) {
        const entry = submissionHistory[i];
        const p = document.createElement('p');
        p.innerHTML = `ข้อมูลล่าสุด : <strong>${entry.code}</strong><br>ส่งสำเร็จเมื่อ: ${entry.time}`;
        submissionHistoryContainer.appendChild(p);
      }
    }

    // Function to add a new entry to history and manage array size
    function addSubmissionToHistory(code, timestamp) {
      submissionHistory.push({ code: code, time: timestamp });
      if (submissionHistory.length > MAX_HISTORY_ITEMS) {
        submissionHistory.shift(); // Remove the oldest entry
      }
      saveSubmissionHistory(); // Save updated history to localStorage
      updateSubmissionHistoryDisplay(); // Update the UI
    }
    
    // Function to load and set remembered fields (รวมถึง date)
    function loadAndSetRememberedFields() {
        fieldsToRemember.forEach(field => {
            const savedValue = localStorage.getItem(field);
            if (savedValue) {
                document.querySelector(`[name="${field}"]`).value = savedValue;
            }
        });
    }

    // Function to reset the form inputs (not the history display)
    function resetFormForNewEntry() {
      form.reset(); // Reset form fields
      // Clear selected buttons
      actionButtons.forEach(button => {
        button.classList.remove('selected');
      });
      selectedButtons.clear();
      updateCpCount(); // Reset CP count
      
      // โหลดค่าฟิลด์ที่จำไว้ (รวมถึงวันที่)
      loadAndSetRememberedFields(); 
    }

    // --- Existing Form Logic (mostly unchanged) ---
    function handleClassChange() {
      const grade = this.value;
      let npValue, nmValue;

      if (grade === "ป.1") {
        npValue = getRandomInt(4, 6);
        nmValue = getRandomInt(18, 20);
      } else if (grade === "ป.3") {
        npValue = getRandomInt(12, 16);
        nmValue = getRandomInt(12, 14);
      } else if (grade === "ป.6") {
        npValue = getRandomInt(24, 26);
        nmValue = getRandomInt(2, 6);
      } else if (grade === "ม.1") {
        npValue = 28;
        nmValue = 0;
      }
      else {
        npValue = '';
        nmValue = '';
      }

      npInput.value = npValue;
      nmInput.value = nmValue;
    }

    function getRandomInt(min, max) {
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const actionButtons = document.querySelectorAll('.action-button');
    const selectedButtons = new Set();

    function updateCpCount() {
      let cpCount = 0;
      document.querySelectorAll('.tooth-treatment-grid .action-button.selected').forEach(button => {
        if (button.dataset.name.startsWith('t') && parseInt(button.dataset.name.substring(1)) >= 11 && parseInt(button.dataset.name.substring(1)) <= 48) {
          cpCount++;
        }
      });
      cpInput.value = cpCount;
    }
    
    function handleActionButtonClick() {
      const buttonName = this.dataset.name;
      
      if (this.classList.contains('selected')) {
        this.classList.remove('selected');
        selectedButtons.delete(buttonName);
      } else {
        this.classList.add('selected');
        selectedButtons.add(buttonName);
      }
      updateCpCount();
    }

    // เมื่อผู้ใช้ส่งฟอร์ม
    function handleFormSubmit(e) {
      e.preventDefault();
      
      submitButton.classList.add('blinking');
      submitButton.disabled = true;

      const formData = new FormData(form);
      formData.append('CP', cpInput.value);

      selectedButtons.forEach(name => {
        formData.append(name, 'on');
      });

      const submittedCode = codeInput.value;
      // Get current time with full date and time for better history
      const submissionDateTime = new Date().toLocaleDateString("th-TH") + " " + new Date().toLocaleTimeString("th-TH", { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      fetch(scriptURL, {
        method: "POST",
        body: formData,
      })
      .then(res => res.text())
      .then(() => {
        // บันทึกค่าฟิลด์ที่จำไว้ทั้งหมด รวมถึงวันที่
        fieldsToRemember.forEach(field => {
          localStorage.setItem(field, document.querySelector(`[name="${field}"]`).value);
        });

        // Add to history and update display
        addSubmissionToHistory(submittedCode, submissionDateTime);
        
        // Reset form fields for the next entry AFTER successful submission
        resetFormForNewEntry(); 

      })
      .catch(() => {
        alert("❌ เกิดข้อผิดพลาดในการส่งข้อมูล");
      })
      .finally(() => {
        submitButton.classList.remove('blinking');
        submitButton.disabled = false;
      });
    }

    // ฟังก์ชันสำหรับตั้งค่าเริ่มต้นของหน้าหลัก
    function initialSetup() {
        // เพิ่ม Event Listeners ของหน้าหลัก
        classInput.addEventListener('change', handleClassChange);
        actionButtons.forEach(button => {
            button.addEventListener('click', handleActionButtonClick);
        });
        form.addEventListener("submit", handleFormSubmit);

        // ตั้งค่า Event Listener สำหรับ Date Picker เพื่อบันทึกค่าทุกครั้งที่มีการเลือก
        dateInput.addEventListener('change', function() {
            localStorage.setItem('date', this.value);
        });

        // ตั้งค่าเริ่มต้นของหน้าหลัก
        loadSubmissionHistory(); // โหลดประวัติการส่ง
        updateSubmissionHistoryDisplay(); // แสดงประวัติ

        // โหลดค่าฟิลด์ที่จำไว้ (รวมถึงวันที่)
        loadAndSetRememberedFields();
    }

    // เมื่อโหลดหน้าเว็บเสร็จ (แต่ยังไม่ผ่านล็อกอิน)
    document.addEventListener("DOMContentLoaded", function() {
        // ซ่อนเนื้อหาหลักจนกว่าจะล็อกอินสำเร็จ
        document.getElementById("main-content").style.display = 'none';

        // เมื่อล็อกอินสำเร็จ ค่อยแสดงเนื้อหาหลัก
        enterButton.addEventListener("click", function() {
            if (currentPasscode === CORRECT_PASSCODE) {
                document.getElementById("main-content").style.display = ''; // แสดงเนื้อหาหลัก
            }
        });
    });
  </script>
</body>
</html>