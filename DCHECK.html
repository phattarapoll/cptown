<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>งานทันตสาธารณสุข</title>
  <link rel="stylesheet" href="assets/css/styleDcheck.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Updated styles for the submission history display */
    #submission-history {
      position: fixed;
      top: 20px;
      right: 20px;
      color: #333; /* Dark gray text color */
      padding: 10px 15px;
      font-weight: bold;
      z-index: 1000;
      display: none; /* Hidden by default, will be shown if history exists */
      line-height: 1.6; /* Spacing between lines */
      text-align: right; /* Align text to the right */
    }
    #submission-history p {
      margin: 0; /* Remove default paragraph margins */
      padding: 3px 0;
      border-bottom: 1px dotted #ccc; /* Subtle separator */
    }
    #submission-history p:last-child {
      border-bottom: none; /* No border for the last item */
    }
    #submission-history p strong {
      color: #0056b3; /* A bit more prominent color for the code */
    }
  </style>
</head>
<body>
  <div id="submission-history"></div> <div class="container">
    <h1> PROGRAM DENTCHECK V.4 </h1>
    
    <form id="dataForm">
      <div class="main-content-grid">
        <div class="left-column">
          <div class="section gray1">
            <label>วันที่
              <input type="text" id="date" name="date" readonly> </label>
            <label>รหัส
              <input type="number" id="code" name="id"> </label>
            <label>ชั้น
              <input type="text" id="class" name="grade" list="gradeOptions"> <datalist id="gradeOptions">
                <option value="ป.1">
                <option value="ป.2">
                <option value="ป.3">
                <option value="ป.4">
                <option value="ป.5">
                <option value="ป.6">
                <option value="ม.1">
              </datalist>
            </label>
            <label>โรงเรียน
              <select id="school" name="school">
                <option value="สหศึกษา">สหศึกษา</option>
                <option value="ฝวาหมินกงลิ">ฝวาหมินกงลิ</option>
                <option value="เทศบาล1ท่าตะเภา">เทศบาล1ท่าตะเภา</option>
                <option value="อนุบาลเมืองชุมพร">อนุบาลเมืองชุมพร</option>			
                <option value="สอาดเผดิมวิทยา">สอาดเผดิมวิทยา</option>
                <option value="ศรียาภัย">ศรียาภัย</option>
              </select>
            </label>
          </div>

          <div class="section gray05">
            <label>จำนวนฟันแท้ <input type="number" min="0" max="32" id="np" name="NP"></label>
            <label>จำนวนฟันแท้ผุ <input type="number" min="0" max="32" id="cp" name="CP" readonly></label>
            <label>จำนวนฟันน้ำนม <input type="number" min="0" max="20" id="nm" name="NM"></label>
            <label>ฟันน้ำนมต้องอุด <input type="number" min="0" max="20" id="cm" name="CM"></label>
          </div>
        </div> <div class="right-column">
          <div class="section gray05 center-buttons">
            <button type="button" class="action-button special" id="scButton" data-name="sc"><span>แนะนำขูดหินปูน</span></button>
            <button type="button" class="action-button special" id="exButton" data-name="ex"><span>แนะนำถอน</span></button>
          </div>

          <div class="section gray076">
            <h2>เคลือบหลุมร่องฟัน (Sealants)</h2>
            <div class="button-group" id="slButtonGroup">
              <button type="button" class="action-button" data-name="sl27"><span>27</span></button>
              <button type="button" class="action-button" data-name="sl26"><span>26</span></button>
              <button type="button" class="action-button" data-name="sl17"><span>17</span></button>
              <button type="button" class="action-button" data-name="sl16"><span>16</span></button>
            </div>
            <div class="button-group">	  
              <button type="button" class="action-button" data-name="sl37"><span>37</span></button>
              <button type="button" class="action-button" data-name="sl36"><span>36</span></button>
              <button type="button" class="action-button" data-name="sl46"><span>46</span></button>
              <button type="button" class="action-button" data-name="sl47"><span>47</span></button>
            </div>
          </div>

          <div class="section gray05">
            <h2>ให้การรักษา (Treatment)</h2>
            <div class="tooth-treatment-grid">
              <button type="button" class="action-button" data-name="t27"><span>27</span></button> <button type="button" class="action-button" data-name="t26"><span>26</span></button> <button type="button" class="action-button" data-name="t25"><span>25</span></button> <button type="button" class="action-button" data-name="t24"><span>24</span></button> <button type="button" class="action-button" data-name="t23"><span>23</span></button> <button type="button" class="action-button" data-name="t22"><span>22</span></button> <button type="button" class="action-button" data-name="t21"><span>21</span></button> <button type="button" class="action-button" data-name="t11"><span>11</span></button> <button type="button" class="action-button" data-name="t12"><span>12</span></button> <button type="button" class="action-button" data-name="t13"><span>13</span></button> <button type="button" class="action-button" data-name="t14"><span>14</span></button> <button type="button" class="action-button" data-name="t15"><span>15</span></button> <button type="button" class="action-button" data-name="t16"><span>16</span></button> <button type="button" class="action-button" data-name="t17"><span>17</span></button>
              <div class="grid-row-break"></div> <button type="button" class="action-button" data-name="t37"><span>37</span></button> <button type="button" class="action-button" data-name="t36"><span>36</span></button> <button type="button" class="action-button" data-name="t35"><span>35</span></button> <button type="button" class="action-button" data-name="t34"><span>34</span></button> <button type="button" class="action-button" data-name="t33"><span>33</span></button> <button type="button" class="action-button" data-name="t32"><span>32</span></button> <button type="button" class="action-button" data-name="t31"><span>31</span></button> <button type="button" class="action-button" data-name="t41"><span>41</span></button> <button type="button" class="action-button" data-name="t42"><span>42</span></button> <button type="button" class="action-button" data-name="t43"><span>43</span></button> <button type="button" class="action-button" data-name="t44"><span>44</span></button> <button type="button" class="action-button" data-name="t45"><span>45</span></button> <button type="button" class="action-button" data-name="t46"><span>46</span></button> <button type="button" class="action-button" data-name="t47"><span>47</span></button>
            </div>
          </div>
          <div class="submit-button-container">
            <button type="submit" class="submit-btn">ส่งข้อมูล</button>
          </div>
        </div> </div> </form>
	<br><br><br><br><br><br>
	<h6>ผู้สร้างและพัฒนา...นายภัทรพล ไพศรพล ไพศาลวัชรเมธี เจ้าพนักงานทันตสาธารณสุขอาวุโส </h6>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwgNSARmEVj9bZU9euDyAkkuOb8PeJOtsHKHVjFcUR0AhP1ZQcOKcs4f4JmKk3H_fv-xg/exec";
    const form = document.getElementById("dataForm");
    const classInput = document.getElementById("class");
    const npInput = document.getElementById("np");
    const nmInput = document.getElementById("nm");
    const cpInput = document.getElementById("cp");
    const submitButton = document.querySelector('.submit-button-container .submit-btn');
    const codeInput = document.getElementById("code");
    const submissionHistoryContainer = document.getElementById('submission-history'); // Changed ID

    const fieldsToRemember = ["date", "grade", "school", "NP", "NM", "CM"];

    let submissionHistory = []; // Array to hold history objects {code: '...', time: '...'}
    const MAX_HISTORY_ITEMS = 2;
    const HISTORY_STORAGE_KEY = 'dentalSubmissionHistory'; // Key for localStorage

    // Function to load history from localStorage
    function loadSubmissionHistory() {
      const saved = localStorage.getItem(HISTORY_STORAGE_KEY);
      if (saved) {
        try {
          submissionHistory = JSON.parse(saved);
          // Ensure it's an array and trim if somehow it got too big
          if (!Array.isArray(submissionHistory)) {
            submissionHistory = [];
          } else if (submissionHistory.length > MAX_HISTORY_ITEMS) {
            submissionHistory = submissionHistory.slice(-MAX_HISTORY_ITEMS); // Take last MAX_HISTORY_ITEMS
          }
        } catch (e) {
          console.error("Error parsing submission history from localStorage:", e);
          submissionHistory = []; // Reset on error
        }
      }
    }

    // Function to save history to localStorage
    function saveSubmissionHistory() {
      localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(submissionHistory));
    }

    // Function to update the display of history on the page
    function updateSubmissionHistoryDisplay() {
      submissionHistoryContainer.innerHTML = ''; // Clear current display
      if (submissionHistory.length === 0) {
        submissionHistoryContainer.style.display = 'none'; // Hide if no history
        return;
      }
      submissionHistoryContainer.style.display = 'block'; // Show if there is history

      // Iterate from most recent to oldest for display order (newest at top)
      for (let i = submissionHistory.length - 1; i >= 0; i--) {
        const entry = submissionHistory[i];
        const p = document.createElement('p');
        p.innerHTML = `ข้อมูลล่าสุด : <strong>${entry.code}</strong><br>ส่งสำเร็จเมื่อ: ${entry.time}`;
        submissionHistoryContainer.appendChild(p);
      }
    }

    // Function to add a new entry to history and manage array size
    function addSubmissionToHistory(code, timestamp) {
      submissionHistory.push({ code: code, time: timestamp });
      if (submissionHistory.length > MAX_HISTORY_ITEMS) {
        submissionHistory.shift(); // Remove the oldest entry
      }
      saveSubmissionHistory(); // Save updated history to localStorage
      updateSubmissionHistoryDisplay(); // Update the UI
    }

    // Function to reset the form inputs (not the history display)
    function resetFormForNewEntry() {
      form.reset(); // Reset form fields
      // Clear selected buttons
      actionButtons.forEach(button => {
        button.classList.remove('selected');
      });
      selectedButtons.clear();
      updateCpCount(); // Reset CP count
      // Reload remembered fields
      document.getElementById("date").value = new Date().toLocaleDateString("th-TH");
      fieldsToRemember.forEach(field => {
        const savedValue = localStorage.getItem(field);
        if (savedValue) {
          document.querySelector(`[name="${field}"]`).value = savedValue;
        }
      });
    }

    // --- Existing Form Logic (mostly unchanged) ---
    classInput.addEventListener('change', function() {
      const grade = this.value;
      let npValue, nmValue;

      if (grade === "ป.1") {
        npValue = getRandomInt(4, 6);
        nmValue = getRandomInt(18, 20);
      } else if (grade === "ป.3") {
        npValue = getRandomInt(12, 16);
        nmValue = getRandomInt(12, 14);
      } else if (grade === "ป.6") {
        npValue = getRandomInt(24, 26);
        nmValue = getRandomInt(2, 6);
      } else if (grade === "ม.1") {
        npValue = 28;
        nmValue = 0;
      }
      else {
        npValue = '';
        nmValue = '';
      }

      npInput.value = npValue;
      nmInput.value = nmValue;
    });

    function getRandomInt(min, max) {
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const actionButtons = document.querySelectorAll('.action-button');
    const selectedButtons = new Set();

    function updateCpCount() {
      let cpCount = 0;
      document.querySelectorAll('.tooth-treatment-grid .action-button.selected').forEach(button => {
        if (button.dataset.name.startsWith('t') && parseInt(button.dataset.name.substring(1)) >= 11 && parseInt(button.dataset.name.substring(1)) <= 48) {
          cpCount++;
        }
      });
      cpInput.value = cpCount;
    }

    actionButtons.forEach(button => {
      button.addEventListener('click', function() {
        const buttonName = this.dataset.name;
        
        if (this.classList.contains('selected')) {
          this.classList.remove('selected');
          selectedButtons.delete(buttonName);
        } else {
          this.classList.add('selected');
          selectedButtons.add(buttonName);
        }
        updateCpCount();
      });
    });

    // เมื่อผู้ใช้ส่งฟอร์ม
    form.addEventListener("submit", e => {
      e.preventDefault();
      
      submitButton.classList.add('blinking');
      submitButton.disabled = true;

      const formData = new FormData(form);
      formData.append('CP', cpInput.value);

		selectedButtons.forEach(name => {
        formData.append(name, 'on');
      });

      const submittedCode = codeInput.value;
      // Get current time with full date and time for better history
      const submissionDateTime = new Date().toLocaleDateString("th-TH") + " " + new Date().toLocaleTimeString("th-TH", { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      fetch(scriptURL, {
        method: "POST",
        body: formData,
      })
      .then(res => res.text())
      .then(() => {
        fieldsToRemember.forEach(field => {
          localStorage.setItem(field, document.querySelector(`[name="${field}"]`).value);
        });

        // Add to history and update display
        addSubmissionToHistory(submittedCode, submissionDateTime);
        
        // Reset form fields for the next entry AFTER successful submission
        resetFormForNewEntry(); 

      })
      .catch(() => {
        alert("❌ เกิดข้อผิดพลาดในการส่งข้อมูล");
      })
      .finally(() => {
        submitButton.classList.remove('blinking');
        submitButton.disabled = false;
      });
    });

    // Initial setup on page load:
    loadSubmissionHistory(); // Load any saved history
    updateSubmissionHistoryDisplay(); // Display it

    document.getElementById("date").value = new Date().toLocaleDateString("th-TH");
    fieldsToRemember.forEach(field => {
      const savedValue = localStorage.getItem(field);
      if (savedValue) {
        document.querySelector(`[name="${field}"]`).value = savedValue;
      }
    });

  </script>
</body>
</html>